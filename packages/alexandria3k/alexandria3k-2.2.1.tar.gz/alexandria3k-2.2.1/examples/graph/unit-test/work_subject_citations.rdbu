BEGIN SETUP
works:
id	doi
1	d1
2	d2
3	d3
4	d4
5	d5
6	d6

work_references:
work_id	doi
1	d2
1	d3
1	d4
1	NULL
5	d1
5	d2
6	d2


works_subjects:
work_id	subject_id
1	1
2	2
3	2
4	2
5	3
5	3
6	1
END

BEGIN CREATE
CREATE TABLE work_subject_citations AS
  SELECT
      citing_subjects.subject_id AS citing_subject_id,
      cited_subjects.subject_id AS cited_subject_id,
      Count(*) AS citations_number
    FROM works AS citing_works
    INNER JOIN work_references ON citing_works.id = work_references.work_id
    INNER JOIN works AS cited_works ON cited_works.doi = work_references.doi
    INNER JOIN works_subjects AS citing_subjects
      ON citing_subjects.work_id = citing_works.id
    INNER JOIN works_subjects AS cited_subjects
      ON cited_subjects.work_id = cited_works.id
    GROUP BY citing_subject_id, cited_subject_id;
END

BEGIN RESULT
work_subject_citations:
citing_subject_id	cited_subject_id	citations_number
1			2			4
3			1			1
3			2			1
END
