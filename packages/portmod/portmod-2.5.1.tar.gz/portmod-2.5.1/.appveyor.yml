image:
  - macos-bigsur
  - Visual Studio 2019

artifacts:
  - path: dist\*

for:
-
  matrix:
    only:
      - image: Visual Studio 2019

  cache:
    - .env
    - .cache
    - 'C:\Users\appveyor\.cargo'
    - 'C:\Users\appveyor\.rustup'
    - "target"

  environment:
    PATH: 'C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;c:\python37-x64\Scripts;C:\Users\appveyor\AppData\Roaming\Python\Python37\Scripts;C:\Program Files\Sandboxie;C:\Users\appveyor\.cargo\bin;C:\Program Files\Git\usr\bin;C:\Program Files\Git\cmd'
    PYTHON: "C:\\Python37-x64"
    PYTHON_EXEC: "C:\\Python37-x64\\python.exe"
    PYTHON_VERSION: "3.7.x"
    PYTHON_ARCH: "64"

  before_build:
  - ps: |
      if (!(Test-Path .cache/SandboxieInstall64-v5.47.1.exe)) {
          New-Item -ItemType Directory -Force -Path .cache
          iwr https://github.com/sandboxie-plus/Sandboxie/releases/download/0.6.7/Sandboxie-Classic-x64-v5.47.1.exe -OutFile .cache/SandboxieInstall64-v5.47.1.exe
      }
      if (!(Test-Path .cache/rustup-init.exe)) {
          iwr https://win.rustup.rs/x86_64 -OutFile .cache/rustup-init.exe
      }
      .cache\SandboxieInstall64-v5.47.1.exe /S /install
      .cache/rustup-init.exe --default-toolchain stable -y --quiet
      Invoke-Expression "$env:PYTHON_EXEC -m pip install pip --upgrade --user"
      Invoke-Expression "$env:PYTHON_EXEC -m pip install virtualenv --upgrade --user"

  build_script:
  - cmd: |
      virtualenv .venv -p python37
      .venv\Scripts\activate
      pip install -e .[test] --cache-dir .cache/pip

  test_script:
  - virtualenv .venv -p python37
  - .venv\Scripts\activate
  - pytest --log-level NOTSET

  deploy_script:
  - IF %APPVEYOR_REPO_TAG% == true (git diff)
  - IF %APPVEYOR_REPO_TAG% == true (git reset --hard)
  - IF %APPVEYOR_REPO_TAG% == true (pip3 install --upgrade twine setuptools_rust)
  - IF %APPVEYOR_REPO_TAG% == true (python setup.py bdist_wheel --py-limited-api=cp37)
  - IF %APPVEYOR_REPO_TAG% == true (twine upload dist/*.whl)

-
  matrix:
    only:
      - image: macos-bigsur
  environment:
    ARCHFLAGS: "-arch x86_64 -arch arm64"
  cache:
    - .venv
    - .cache
    - $HOME/.cargo
    - $HOME/.rustup
    - target

  build_script:
    - export PATH="$HOME/.cargo/bin:$PATH"
    - which python3
    - python3 -m pip install virtualenv pip --upgrade --user
    - virtualenv .venv -p python38
    - source .venv/bin/activate
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > rustup.sh
    - chmod +x rustup.sh
    - ./rustup.sh --default-toolchain stable -y --quiet
    - rustup target add aarch64-apple-darwin
    - python3 -m pip install -e .[test] --cache-dir .cache/pip
  test_script:
    - pytest --cov=portmod --cov=pybuild_ --log-level NOTSET

  deploy_script: |
    if [ $APPVEYOR_REPO_TAG = true ]; then
        pip3 install --upgrade twine setuptools_rust sphinx sphinx-argparse
        python3 setup.py build_rust --inplace --release build_man
        python3 setup.py bdist_wheel --py-limited-api=cp37
        twine upload dist/*.whl
    fi
