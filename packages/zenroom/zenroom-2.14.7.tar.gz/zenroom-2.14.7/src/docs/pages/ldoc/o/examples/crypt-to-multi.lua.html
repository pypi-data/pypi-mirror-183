<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Zenroom LUA</title>
    <link rel="stylesheet" href="" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Zenroom</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>



<h2>Examples</h2>
<ul class="nowrap">
  <li><a href="../examples/keygen.lua.html">keygen.lua</a></li>
  <li><strong>crypt-to-multi.lua</strong></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/OCTET.html">OCTET</a></li>
  <li><a href="../modules/HASH.html">HASH</a></li>
  <li><a href="../modules/AES.html">AES</a></li>
  <li><a href="../modules/ECDH.html">ECDH</a></li>
  <li><a href="../modules/ECP.html">ECP</a></li>
  <li><a href="../modules/String.html">String</a></li>
  <li><a href="../modules/Table.html">Table</a></li>
  <li><a href="../modules/INSPECT.html">INSPECT</a></li>
  <li><a href="../modules/ZEN.html">ZEN</a></li>
  <li><a href="../modules/BIG.html">BIG</a></li>
</ul>

</div>

<div id="content">

    <h2>crypt-to-multi.lua</h2>
<pre>
<span class="comment">-- encrypt a secret to multiple recipients
</span>
<span class="comment">-- run with arguments:
</span><span class="comment">--  -a crypto-to-multi.data -k crypt-to-multi.keys
</span>
<span class="comment">-- inside KEYS is a list of names and public keys encoded with b58; it
</span><span class="comment">-- returns a list of recipients and encrypted secrets for each and the
</span><span class="comment">-- sender's public key
</span>
secret = str(DATA)

keys = JSON.decode(KEYS)

<span class="comment">-- this is our own secret key, combined with the recipient's public
</span><span class="comment">-- key to obtain a session key
</span><span class="keyword">local</span> private = url64(keys.keyring.secret)
res = {}

<span class="comment">-- loop through all recipients
</span><span class="keyword">for</span> name,pubkey <span class="keyword">in</span> <span class="global">pairs</span>(keys.recipients) <span class="keyword">do</span>
   <span class="comment">-- calculate the session key
</span>
   session = ECDH.session(private, O.from_url64(pubkey))
   iv = O.random(<span class="number">32</span>)

   out = { header = <span class="string">"encoded using zenroom "</span> .. VERSION.original}
   <span class="comment">-- encrypt the message with the session key
</span>   out.text, out.checksum =
	  AES.gcm_encrypt(KDF(session), secret, iv, out.header)

   <span class="comment">-- insert results in final json array
</span>   res[name] = url64( JSON.encode(out) )
<span class="keyword">end</span>

<span class="comment">-- return the json array
</span><span class="global">print</span>(JSON.encode(res))</pre>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2020-04-16 01:32:19 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
