
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>livemaker.cli.lmlsb &#8212; pylivemaker 1.0.0-dev documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for livemaker.cli.lmlsb</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#</span>
<span class="c1"># Copyright (C) 2020 Peter Rowlands &lt;peter@pmrowla.com&gt;</span>
<span class="c1"># Copyright (C) 2014 tinfoil &lt;https://bitbucket.org/tinfoil/&gt;</span>
<span class="c1">#</span>
<span class="c1"># This file is a part of pylivemaker.</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU General Public License as published by the Free Software</span>
<span class="c1"># Foundation, either version 3 of the License, or (at your option) any later</span>
<span class="c1"># version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License along with</span>
<span class="c1"># this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;LiveMaker LSB script CLI tool.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">livemaker.lsb</span> <span class="kn">import</span> <span class="n">LMScript</span>
<span class="kn">from</span> <span class="nn">livemaker.lsb.command</span> <span class="kn">import</span> <span class="n">BaseComponentCommand</span><span class="p">,</span> <span class="n">Calc</span><span class="p">,</span> <span class="n">CommandType</span><span class="p">,</span> <span class="n">Jump</span><span class="p">,</span> <span class="n">LabelReference</span>
<span class="kn">from</span> <span class="nn">livemaker.lsb.core</span> <span class="kn">import</span> <span class="n">OpeData</span><span class="p">,</span> <span class="n">OpeDataType</span><span class="p">,</span> <span class="n">OpeFuncType</span><span class="p">,</span> <span class="n">Param</span><span class="p">,</span> <span class="n">ParamType</span>
<span class="kn">from</span> <span class="nn">livemaker.lsb.menu</span> <span class="kn">import</span> <span class="n">LPMSelectionChoice</span>
<span class="kn">from</span> <span class="nn">livemaker.lsb.novel</span> <span class="kn">import</span> <span class="n">LNSDecompiler</span><span class="p">,</span> <span class="n">LNSCompiler</span><span class="p">,</span> <span class="n">TWdChar</span><span class="p">,</span> <span class="n">TWdOpeReturn</span>
<span class="kn">from</span> <span class="nn">livemaker.project</span> <span class="kn">import</span> <span class="n">PylmProject</span>
<span class="kn">from</span> <span class="nn">livemaker.lsb.translate</span> <span class="kn">import</span> <span class="n">make_identifier</span><span class="p">,</span> <span class="n">TextBlockIdentifier</span><span class="p">,</span> <span class="n">TextMenuIdentifier</span>
<span class="kn">from</span> <span class="nn">livemaker.exceptions</span> <span class="kn">import</span> <span class="n">BadLsbError</span><span class="p">,</span> <span class="n">BadTextIdentifierError</span><span class="p">,</span> <span class="n">LiveMakerException</span>

<span class="kn">from</span> <span class="nn">.cli</span> <span class="kn">import</span> <span class="n">_version</span><span class="p">,</span> <span class="n">__version__</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">version_option</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">_version</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lmlsb</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Command-line tool for manipulating LSB scripts.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">probe</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Output information about the specified LSB file in human-readable form.</span>

<span class="sd">    Novel script scenario character and line count are estimates. Depending</span>
<span class="sd">    on how a script was originally created, actual char/line counts may vary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lm</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not read file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">_parsed_from</span> <span class="o">==</span> <span class="s2">&quot;lsc&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LiveMaker LSC script file:&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lm</span><span class="o">.</span><span class="n">_parsed_from</span> <span class="o">==</span> <span class="s2">&quot;lsc-xml&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LiveMaker XML LSC script file:&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">lm</span><span class="o">.</span><span class="n">_parsed_from</span> <span class="o">==</span> <span class="s2">&quot;lsb&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LiveMaker compiled LSB script file:&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LiveMaker script file:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Version: </span><span class="si">{}</span><span class="s2"> (LiveMaker</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">lm</span><span class="o">.</span><span class="n">lm_version</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Total commands: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lm</span><span class="p">)))</span>
    <span class="n">cmd_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">lm</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
        <span class="n">cmd_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Command types: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cmd_types</span><span class="p">)])))</span>
    <span class="n">scenarios</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Total text scenarios: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scenarios</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Unlabeled scenario&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">tpwd_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">char_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">wd</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">tpwd_types</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">wd</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">TWdChar</span><span class="p">):</span>
                <span class="n">char_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">TWdOpeReturn</span><span class="p">):</span>
                <span class="n">line_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      LiveNovel scenario version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      TpWd types: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tpwd_types</span><span class="p">)])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      Approx. character count: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">char_count</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">char_count</span><span class="p">:</span>
            <span class="c1"># don&#39;t count line breaks in event-only scenarios</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;      Approx. line count: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_count</span><span class="p">))</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify that the specified LSB file(s) can be processed.</span>

<span class="sd">    Validation is done by disassembling an input file, reassembling it,</span>
<span class="sd">    and then comparing the SHA256 digests of the original and reassembled</span>
<span class="sd">    versions of the file.</span>

<span class="sd">    If a file contains text scenarios, a test will also be done to verify that</span>
<span class="sd">    the scenarios can be decompiled, recompiled, and then reinserted into the</span>
<span class="sd">    lsb file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_lsb</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">orig</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">built_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
            <span class="n">reassembled</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">built_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Failed to reassemble file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Orig: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> bytes)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   New: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2"> bytes)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reassembled</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">built_data</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">orig</span> <span class="o">==</span> <span class="n">reassembled</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SHA256 digest validation passed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig</span> <span class="o">!=</span> <span class="n">reassembled</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  SHA256 digest validation failed&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">(</span><span class="n">run_order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">orig_bytes</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">_struct</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">LNSDecompiler</span><span class="p">()</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">LNSCompiler</span><span class="p">()</span>
            <span class="n">new_body</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">replace_body</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
            <span class="n">new_bytes</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">_struct</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_bytes</span> <span class="o">==</span> <span class="n">orig_bytes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  script passed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  script mismatch, </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_bytes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_bytes</span><span class="p">)))</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--mode&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;xml&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">]),</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output mode (defaults to text)&quot;</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--output-file&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file. If unspecified, output will be dumped to stdout.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dump the contents of the specified LSB file(s) to stdout in a human-readable format.</span>

<span class="sd">    For text mode, the full LSB will be output as human-readable text.</span>

<span class="sd">    For xml mode, the full LSB file will be output as an XML document.</span>

<span class="sd">    For lines mode, only text lines will be output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_file</span><span class="p">:</span>
        <span class="n">outf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outf</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

    <span class="n">pylm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">skip_pylm</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skip_pylm</span><span class="p">:</span>
                <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">pylm</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pylm</span> <span class="o">=</span> <span class="n">PylmProject</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">call_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">call_name</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">LiveMakerException</span><span class="p">:</span>
                    <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">skip_pylm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">call_name</span><span class="o">=</span><span class="n">call_name</span><span class="p">,</span> <span class="n">pylm</span><span class="o">=</span><span class="n">pylm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pylm</span><span class="p">:</span>
                <span class="n">pylm</span><span class="o">.</span><span class="n">update_labels</span><span class="p">(</span><span class="n">lsb</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;xml&quot;</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">),</span>
                <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span>
            <span class="n">lsb_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.lns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-line</span><span class="si">{}</span><span class="s2">.lns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_text_blocks</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">Mute</span><span class="p">:</span>
                    <span class="n">mute</span> <span class="o">=</span> <span class="s2">&quot;;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mute</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}{:4}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mute</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">LineNo</span><span class="p">,</span> <span class="s2">&quot;    &quot;</span> <span class="o">*</span> <span class="n">c</span><span class="o">.</span><span class="n">Indent</span><span class="p">)]</span>
                <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">))</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Page&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">LabelReference</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">Page</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;lsb&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pylm</span><span class="p">:</span>
                        <span class="c1"># resolve lsb refs</span>
                        <span class="n">line_no</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">resolve_label</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">line_no</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; (Label </span><span class="si">{line_no}</span><span class="s2">: </span><span class="si">{name}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">CommandType</span><span class="o">.</span><span class="n">TextIns</span><span class="p">:</span>
                    <span class="n">dec</span> <span class="o">=</span> <span class="n">LNSDecompiler</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Text&quot;</span><span class="p">)),</span> <span class="n">file</span><span class="o">=</span><span class="n">outf</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_escape_scenario_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace invalid Windows path characters with underscore.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\/:*?&quot;&lt;&gt;|]+&#39;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--output-dir&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">file_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output directory. Defaults to the current working directory if not specified.&quot;</span>
    <span class="s2">&quot; If directory does not exist it will be created.&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;input_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">input_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract decompiled LiveNovel scripts from the specified input file(s).</span>

<span class="sd">    By default, extracted scripts will be encoded as utf-8, but if you intend</span>
<span class="sd">    to patch a script back into an LSB, you will still be limited to cp932</span>
<span class="sd">    characters only.</span>

<span class="sd">    Output files will be named &lt;LSB name&gt;-&lt;scenario name&gt;.lns</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting scripts from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">lsb_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">lsb_ref_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.lsbref&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lsb_ref_filename</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">lsb_ref_file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.lns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">_escape_scenario_name</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-line</span><span class="si">{}</span><span class="s2">.lns&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dec</span> <span class="o">=</span> <span class="n">LNSDecompiler</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">decompile</span><span class="p">(</span><span class="n">scenario</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  wrote </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
                <span class="n">lsb_ref_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The text encoding of script_file (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;script_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="c1"># TODO: make this optional and parse label/line number from script filename</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;line_number&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-backup&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not generate backup of original archive file(s).&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile specified LNS script and insert it into the specified LSB file.</span>

<span class="sd">    The LSB command at line_number must be a TextIns command. The existing text</span>
<span class="sd">    block of the specified TextIns command will be replaced with the new one from</span>
<span class="sd">    script_file.</span>

<span class="sd">    script_file should be an LNS script which was initially generated by lmlsb extract.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak unless the</span>
<span class="sd">    --no-backup option is specified.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">insert_lns</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">)</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The text encoding of script_file (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;script_dir&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">file_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-backup&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not generate backup of original archive file(s).&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;--ignore-missing&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Continue insert in case of missing script file(s).&quot;</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">batchinsert</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">script_dir</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">,</span> <span class="n">ignore_missing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile specified LNS script directory and insert it into the specified LSB file according to</span>
<span class="sd">    the Reference file.</span>

<span class="sd">    The Reference file must be inside script_dir.</span>

<span class="sd">    script_dir should be an LNS script directory which was initially generated by lmlsb extract.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak unless the</span>
<span class="sd">    --no-backup option is specified.</span>

<span class="sd">    If a file from .lsbref is missing, insertation is stopped, unless the</span>
<span class="sd">    --ignore-missing option is specified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">script_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">script_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">script_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input directory does not exist&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_backup</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backing up original LSB.&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not open LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">lsb_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="n">lsb_ref_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.lsbref&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_path</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lsb_ref_filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">lsb_ref_file</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">lsb_ref_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">ln</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">lnsplt</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">script_file</span> <span class="o">=</span> <span class="n">script_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">lnsplt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">line_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lnsplt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">script_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">ignore_missing</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: script file </span><span class="si">{}</span><span class="s2"> is missing, skipped.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_file</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Script file is missing: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">script_file</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">script</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">LNSCompiler</span><span class="p">()</span>
                <span class="n">new_body</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not compile script file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">line_number</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scenario </span><span class="si">{}</span><span class="s2"> at line </span><span class="si">{}</span><span class="s2"> will be replaced.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
                    <span class="n">scenario</span><span class="o">.</span><span class="n">replace_body</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_lsb_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lsb_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote new LSB.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not generate new LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="c1"># Known property data types</span>
<span class="n">EDITABLE_PROPERTY_TYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># PR_NONE = 0x00</span>
    <span class="c1"># PR_NAME = 0x01</span>
    <span class="c1"># PR_PARENT = 0x02</span>
    <span class="c1"># PR_SOURCE = 0x03</span>
    <span class="c1"># PR_LEFT = 0x04</span>
    <span class="c1"># PR_TOP = 0x05</span>
    <span class="c1"># PR_WIDTH = 0x06</span>
    <span class="c1"># PR_HEIGHT = 0x07</span>
    <span class="c1"># PR_ZOOMX = 0x08</span>
    <span class="c1"># PR_COLOR = 0x09</span>
    <span class="c1"># PR_BORDERWIDTH = 0x0a</span>
    <span class="c1"># PR_BORDERCOLOR = 0x0b</span>
    <span class="c1"># PR_ALPHA = 0x0c</span>
    <span class="s2">&quot;PR_PRIORITY&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="c1"># PR_OFFSETX = 0x0e</span>
    <span class="c1"># PR_OFFSETY = 0x0f</span>
    <span class="c1"># PR_FONTNAME = 0x10</span>
    <span class="s2">&quot;PR_FONTHEIGHT&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="c1"># PR_FONTSTYLE = 0x12</span>
    <span class="s2">&quot;PR_LINESPACE&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTCOLOR&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTLINKCOLOR&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTBORDERCOLOR&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTHOVERCOLOR&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="c1"># PR_FONTHOVERSTYLE = 0x18</span>
    <span class="c1"># PR_HOVERCOLOR = 0x19</span>
    <span class="s2">&quot;PR_ANTIALIAS&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_DELAY = 0x1b</span>
    <span class="s2">&quot;PR_PAUSED&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_VOLUME = 0x1d</span>
    <span class="c1"># PR_REPEAT = 0x1e</span>
    <span class="c1"># PR_BALANCE = 0x1f</span>
    <span class="c1"># PR_ANGLE = 0x20</span>
    <span class="c1"># PR_ONPLAYING = 0x21</span>
    <span class="c1"># PR_ONNOTIFY = 0x22</span>
    <span class="c1"># PR_ONMOUSEMOVE = 0x23</span>
    <span class="c1"># PR_ONMOUSEOUT = 0x24</span>
    <span class="c1"># PR_ONLBTNDOWN = 0x25</span>
    <span class="c1"># PR_ONLBTNUP = 0x26</span>
    <span class="c1"># PR_ONRBTNDOWN = 0x27</span>
    <span class="c1"># PR_ONRBTNUP = 0x28</span>
    <span class="c1"># PR_ONWHEELDOWN = 0x29</span>
    <span class="c1"># PR_ONWHEELUP = 0x2a</span>
    <span class="c1"># PR_BRIGHTNESS = 0x2b</span>
    <span class="c1"># PR_ONPLAYEND = 0x2c</span>
    <span class="c1"># PR_INDEX = 0x2d</span>
    <span class="c1"># PR_COUNT = 0x2e</span>
    <span class="c1"># PR_ONLINK = 0x2f</span>
    <span class="s2">&quot;PR_VISIBLE&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_COLCOUNT = 0x31</span>
    <span class="c1"># PR_ROWCOUNT = 0x32</span>
    <span class="c1"># PR_TEXT = 0x33</span>
    <span class="c1"># PR_MARGINX = 0x34</span>
    <span class="c1"># PR_MARGINY = 0x35</span>
    <span class="c1"># PR_HALIGN = 0x36</span>
    <span class="c1"># PR_BORDERSOURCETL = 0x37</span>
    <span class="c1"># PR_BORDERSOURCETC = 0x38</span>
    <span class="c1"># PR_BORDERSOURCETR = 0x39</span>
    <span class="c1"># PR_BORDERSOURCECL = 0x3a</span>
    <span class="c1"># PR_BORDERSOURCECC = 0x3b</span>
    <span class="c1"># PR_BORDERSOURCECR = 0x3c</span>
    <span class="c1"># PR_BORDERSOURCEBL = 0x3d</span>
    <span class="c1"># PR_BORDERSOURCEBC = 0x3e</span>
    <span class="c1"># PR_BORDERSOURCEBR = 0x3f</span>
    <span class="c1"># PR_BORDERHALIGNT = 0x40</span>
    <span class="c1"># PR_BORDERHALIGNC = 0x41</span>
    <span class="c1"># PR_BORDERHALIGNB = 0x42</span>
    <span class="c1"># PR_BORDERVALIGNL = 0x43</span>
    <span class="c1"># PR_BORDERVALIGNC = 0x44</span>
    <span class="c1"># PR_BORDERVALIGNR = 0x45</span>
    <span class="c1"># PR_SCROLLSOURCE = 0x46</span>
    <span class="c1"># PR_CHECKSOURCE = 0x47</span>
    <span class="c1"># PR_AUTOSCRAP = 0x48</span>
    <span class="c1"># PR_ONSELECT = 0x49</span>
    <span class="c1"># PR_RCLICKSCRAP = 0x4a</span>
    <span class="c1"># PR_ONOPENING = 0x4b</span>
    <span class="c1"># PR_ONOPENED = 0x4c</span>
    <span class="c1"># PR_ONCLOSING = 0x4d</span>
    <span class="c1"># PR_ONCLOSED = 0x4e</span>
    <span class="c1"># PR_CARETX = 0x4f</span>
    <span class="c1"># PR_CARETY = 0x50</span>
    <span class="s2">&quot;PR_IGNOREMOUSE&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_TEXTPAUSED&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_TEXTDELAY = 0x53</span>
    <span class="c1"># PR_HOVERSOURCE = 0x54</span>
    <span class="c1"># PR_PRESSEDSOURCE = 0x55</span>
    <span class="c1"># PR_GROUPINDEX = 0x56</span>
    <span class="c1"># PR_ALLOWALLUP = 0x57</span>
    <span class="c1"># PR_SELECTED = 0x58</span>
    <span class="c1"># PR_CAPTUREMASK = 0x59</span>
    <span class="c1"># PR_POWER = 0x5a</span>
    <span class="c1"># PR_ORIGWIDTH = 0x5b</span>
    <span class="c1"># PR_ORIGHEIGHT = 0x5c</span>
    <span class="c1"># PR_APPEARX = 0x5d</span>
    <span class="c1"># PR_APPEARY = 0x5e</span>
    <span class="c1"># PR_PARTMOTION = 0x5f</span>
    <span class="c1"># PR_PARAM = 0x60</span>
    <span class="c1"># PR_PARAM2 = 0x61</span>
    <span class="c1"># PR_TOPINDEX = 0x62</span>
    <span class="c1"># PR_READONLY = 0x63</span>
    <span class="c1"># PR_CURSOR = 0x64</span>
    <span class="c1"># PR_POSZOOMED = 0x65</span>
    <span class="c1"># PR_ONPLAYSTART = 0x66</span>
    <span class="c1"># PR_PARAM3 = 0x67</span>
    <span class="c1"># PR_ONMOUSEIN = 0x68</span>
    <span class="c1"># PR_ONMAPIN = 0x69</span>
    <span class="c1"># PR_ONMAPOUT = 0x6a</span>
    <span class="c1"># PR_MAPSOURCE = 0x6b</span>
    <span class="c1"># PR_AMP = 0x6c</span>
    <span class="c1"># PR_WAVELEN = 0x6d</span>
    <span class="c1"># PR_SCROLLX = 0x6e</span>
    <span class="c1"># PR_SCROLLY = 0x6f</span>
    <span class="c1"># PR_FLIPH = 0x70</span>
    <span class="c1"># PR_FLIPV = 0x71</span>
    <span class="c1"># PR_ONIDLE = 0x72</span>
    <span class="c1"># PR_DISTANCEX = 0x73</span>
    <span class="c1"># PR_DISTANCEY = 0x74</span>
    <span class="c1"># PR_CLIPLEFT = 0x75</span>
    <span class="c1"># PR_CLIPTOP = 0x76</span>
    <span class="c1"># PR_CLIPWIDTH = 0x77</span>
    <span class="c1"># PR_CLIPHEIGHT = 0x78</span>
    <span class="c1"># PR_DURATION = 0x79</span>
    <span class="c1"># PR_THUMBSOURCE = 0x7a</span>
    <span class="c1"># PR_BUTTONSOURCE = 0x7b</span>
    <span class="c1"># PR_MIN = 0x7c</span>
    <span class="c1"># PR_MAX = 0x7d</span>
    <span class="c1"># PR_VALUE = 0x7e</span>
    <span class="c1"># PR_ORIENTATION = 0x7f</span>
    <span class="c1"># PR_SMALLCHANGE = 0x80</span>
    <span class="c1"># PR_LARGECHANGE = 0x81</span>
    <span class="c1"># PR_MAPTEXT = 0x82</span>
    <span class="c1"># PR_GLYPHWIDTH = 0x83</span>
    <span class="c1"># PR_GLYPHHEIGHT = 0x84</span>
    <span class="c1"># PR_ZOOMY = 0x85</span>
    <span class="c1"># PR_CLICKEDSOURCE = 0x86</span>
    <span class="c1"># PR_ANIPAUSED = 0x87</span>
    <span class="c1"># PR_ONHOLD = 0x88</span>
    <span class="c1"># PR_ONRELEASE = 0x89</span>
    <span class="c1"># PR_REVERSE = 0x8a</span>
    <span class="c1"># PR_PLAYING = 0x8b</span>
    <span class="c1"># PR_REWINDONLOAD = 0x8c</span>
    <span class="c1"># PR_COMPOTYPE = 0x8d</span>
    <span class="s2">&quot;PR_FONTSHADOWCOLOR&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTBORDER&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="s2">&quot;PR_FONTSHADOW&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
    <span class="c1"># PR_ONKEYDOWN = 0x91</span>
    <span class="c1"># PR_ONKEYUP = 0x92</span>
    <span class="c1"># PR_ONKEYREPEAT = 0x93</span>
    <span class="s2">&quot;PR_HANDLEKEY&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_ONFOCUSIN = 0x95</span>
    <span class="c1"># PR_ONFOCUSOUT = 0x96</span>
    <span class="c1"># PR_OVERLAY = 0x97</span>
    <span class="c1"># PR_TAG = 0x98</span>
    <span class="s2">&quot;PR_CAPTURELINK&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_FONTHOVERBORDER = 0x9a</span>
    <span class="c1"># PR_FONTHOVERBORDERCOLOR = 0x9b</span>
    <span class="c1"># PR_FONTHOVERSHADOW = 0x9c</span>
    <span class="c1"># PR_FONTHOVERSHADOWCOLOR = 0x9d</span>
    <span class="c1"># PR_BARSIZE = 0x9e</span>
    <span class="c1"># PR_MUTEONLOAD = 0x9f</span>
    <span class="c1"># PR_PLUSX = 0xa0</span>
    <span class="c1"># PR_PLUSY = 0xa1</span>
    <span class="c1"># PR_CARETHEIGHT = 0xa2</span>
    <span class="c1"># PR_REPEATPOS = 0xa3</span>
    <span class="c1"># PR_BLURSPAN = 0xa4</span>
    <span class="c1"># PR_BLURDELAY = 0xa5</span>
    <span class="s2">&quot;PR_FONTCHANGEABLED&quot;</span><span class="p">:</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span>
    <span class="c1"># PR_IMEMODE = 0xa7</span>
    <span class="c1"># PR_FLOATANGLE = 0xa8</span>
    <span class="c1"># PR_FLOATZOOMX = 0xa9</span>
    <span class="c1"># PR_FLOATZOOMY = 0xaa</span>
    <span class="c1"># PR_CAPMASKLEVEL = 0xab</span>
    <span class="c1"># PR_PADDINGLEFT = 0xac</span>
    <span class="c1"># PR_PADDING_RIGHT = 0xad</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_check_string_literal</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Warning: String literals should be entered as double quoted (&quot;) strings, &#39;</span>
            <span class="s1">&#39;assuming you meant to enter &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s1">&#39;Warning: String literals should be entered as double quoted (&quot;) strings, &#39;</span>
            <span class="s1">&#39;assuming you meant to enter &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_edit_parser_op</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Operand&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Str</span><span class="p">:</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">orig</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">orig</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Str</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">_check_string_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">,</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected an integer value, skipping field&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Float</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected a floating point value, skipping field&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expected a variable name, var names cannot start with &quot;, skipping field&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">def</span> <span class="nf">_edit_delimited_string_op</span><span class="p">(</span><span class="n">str_op</span><span class="p">,</span> <span class="n">sep_op</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;String&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit delimited string str_op (delimited by sep_op).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">str_op</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Str</span> <span class="ow">or</span> <span class="n">str_op</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Str</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Expected a delimited string and separator, skipping field.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">new_strs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="n">sep_op</span><span class="o">.</span><span class="n">value</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">str_op</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  Entry strings cannot contain the delimiter string (&quot;</span><span class="si">{}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">new_strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_check_string_literal</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="n">str_op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_strs</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> separator&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prompt</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sep</span><span class="p">))</span>
    <span class="n">sep_op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">_check_string_literal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_edit_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit fields in a TLiveParser.&quot;&quot;&quot;</span>
    <span class="c1"># map ____&lt;arg&gt; variables to the appropriate entry index for this parser</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parser</span><span class="p">))</span>
    <span class="n">entry_index</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OpeDataType</span><span class="o">.</span><span class="n">To</span> <span class="ow">and</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;____&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Got unexpected OpeDataType.To entry&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">entry_index</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OpeDataType</span><span class="o">.</span><span class="n">Func</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">OpeFuncType</span><span class="o">.</span><span class="n">AddArray</span><span class="p">:</span>
                <span class="c1"># Format should be AddArray(&lt;array_variable&gt;, &lt;value&gt;)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping complex AddArray entry&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">array_var_op</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">array_var_op</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AddArray operand 0 is not a variable name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">value_entry_index</span> <span class="o">=</span> <span class="n">entry_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_entry_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AddArray operand 1 does not point to a valid parser ____&lt;arg&gt; entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">value_entry_op</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">value_entry_index</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">array_var_op</span><span class="p">,</span> <span class="s2">&quot;  Array variable&quot;</span><span class="p">)</span>
                <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">value_entry_op</span><span class="p">,</span> <span class="s2">&quot;  Array entry&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">OpeFuncType</span><span class="o">.</span><span class="n">StringToArray</span><span class="p">:</span>
                <span class="c1"># Format should be StringToArray(&lt;delimited_string&gt;,</span>
                <span class="c1">#   &lt;array_variable&gt;, &lt;separator&gt;)</span>
                <span class="c1"># where array entries are delimited by &lt;separator&gt;.</span>
                <span class="c1">#</span>
                <span class="c1"># i.e. StringToArray(&quot;foo,bar&quot;, my_array, &quot;,&quot;) sets</span>
                <span class="c1"># my_array = [&quot;foo&quot;, &quot;bar&quot;]</span>
                <span class="c1">#</span>
                <span class="c1"># NOTE: we allow editing of array entry strings for translation</span>
                <span class="c1"># purposes, but do not allow adding or removing entire entries</span>
                <span class="c1"># since modifying the array length would most likely break LM</span>
                <span class="c1"># core engine scripts.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Str</span>
                    <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span>
                    <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span>
                <span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping unexpected StringToArray entry&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">sep_entry_index</span> <span class="o">=</span> <span class="n">entry_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sep_entry_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;StringToArray operand 2 does not point to a valid parser ____&lt;arg&gt; entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">sep_entry_op</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">sep_entry_index</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;  Array variable&quot;</span><span class="p">)</span>
                <span class="n">_edit_delimited_string_op</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sep_entry_op</span><span class="p">,</span> <span class="s2">&quot;  Array entry&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping uneditable parser func type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">OpeDataType</span><span class="o">.</span><span class="n">To</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping complex assignment&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="s2">&quot;  Destination variable&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;  Value&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">entry</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">Equal</span><span class="p">,</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">Big</span><span class="p">,</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">Small</span><span class="p">,</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">EBig</span><span class="p">,</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">ESmall</span><span class="p">,</span>
            <span class="n">OpeDataType</span><span class="o">.</span><span class="n">NEqual</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># boolean comparison</span>
            <span class="n">lhs_op</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lhs_op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lhs_op</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;____&quot;</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">entry_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lhs_op</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparison operand 0 does not point to a valid parser ____&lt;arg&gt; entry&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">lhs_op</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">lhs_op</span><span class="p">,</span> <span class="s2">&quot;  Left hand side&quot;</span><span class="p">)</span>
            <span class="n">rhs_op</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rhs_op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Var</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rhs_op</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;____&quot;</span><span class="p">):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">entry_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rhs_op</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparison operand 1 does not point to a valid parser ____&lt;arg&gt; entry&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">rhs_op</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_edit_parser_op</span><span class="p">(</span><span class="n">rhs_op</span><span class="p">,</span> <span class="s2">&quot;  Right hand side&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping uneditable parser entry: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">entry</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_edit_calc</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a Calc command.</span>

<span class="sd">    Note:</span>
<span class="sd">        Only a limited set of OpeFuncType calc types can be edited.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Calc&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping empty Calc() command.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Editing Calc expression&quot;</span><span class="p">)</span>
    <span class="n">_edit_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_edit_component</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a BaseComponent (or subclass) command.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter new value for each field (or keep existing value)&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cmd</span><span class="o">.</span><span class="n">_component_keys</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c1"># TODO: editing complex fields and adding values for empty fields will</span>
        <span class="c1"># require full LiveParser expression parsing, for now we can only edit</span>
        <span class="c1"># simple scalar values.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">OpeDataType</span><span class="o">.</span><span class="n">To</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">EDITABLE_PROPERTY_TYPES</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]: &lt;skipping uneditable field&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">parser</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">operands</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">op</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span> <span class="ow">or</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">:</span>
                        <span class="n">op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">op</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Float</span><span class="p">:</span>
                        <span class="n">op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">op</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">param_type</span> <span class="o">=</span> <span class="n">EDITABLE_PROPERTY_TYPES</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Int</span> <span class="ow">or</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Flag</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">param_type</span> <span class="o">==</span> <span class="n">ParamType</span><span class="o">.</span><span class="n">Float</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">longdouble</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">Param</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">param_type</span><span class="p">)</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">OpeData</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">OpeDataType</span><span class="o">.</span><span class="n">To</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;____arg&quot;</span><span class="p">,</span> <span class="n">operands</span><span class="o">=</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid datatype for </span><span class="si">{}</span><span class="s2">, skipping.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_edit_jump</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a jump command.&quot;&quot;&quot;</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Page&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">page</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Jump() command with no jump target&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="s2">&quot;Jump target page&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">Page</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">Page</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">Page</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">click</span><span class="o">.</span><span class="n">prompt</span><span class="p">(</span><span class="s2">&quot;Jump target label ID&quot;</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">Label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">page</span><span class="o">.</span><span class="n">Label</span><span class="p">:</span>
        <span class="n">page</span><span class="o">.</span><span class="n">Label</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Calc&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="p">:</span>
        <span class="c1"># conditional calc optional</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Editing jump condition expression&quot;</span><span class="p">)</span>
    <span class="n">_edit_parser</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;line_number&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="n">line_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit the specified command within an LSB file.</span>

<span class="sd">    Only specific command types and specific fields can be edited.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak</span>

<span class="sd">    WARNING: This command should only be used by advanced users familiar with the LiveMaker engine.</span>
<span class="sd">    Improper use of this command may cause undefined behavior (or a complete crash)</span>
<span class="sd">    in the LiveMaker engine during runtime.</span>

<span class="sd">    Note: Setting empty fields to improper data types may cause</span>
<span class="sd">    undefined behavior in the LiveMaker engine. When editing a field,</span>
<span class="sd">    the data type of the new value is assumed to be the same as the</span>
<span class="sd">    original data type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not open LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">LineNo</span> <span class="o">==</span> <span class="n">line_number</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Command </span><span class="si">{}</span><span class="s2"> does not exist in the specified LSB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_number</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line_number</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">BaseComponentCommand</span><span class="p">):</span>
        <span class="n">_edit_component</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">Calc</span><span class="p">):</span>
        <span class="n">_edit_calc</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">Jump</span><span class="p">):</span>
        <span class="n">_edit_jump</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Cannot edit </span><span class="si">{}</span><span class="s2"> commands.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backing up original LSB.&quot;</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_lsb_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lsb_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote new LSB.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not generate new LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<div class="viewcode-block" id="insert_lns"><a class="viewcode-back" href="../../../livemaker.cli.html#livemaker.cli.lmlsb.insert_lns">[docs]</a><span class="k">def</span> <span class="nf">insert_lns</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">script_file</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile specified LNS script and insert it into the specified LSB file.</span>

<span class="sd">    The LSB command at line_number must be a TextIns command. The existing text</span>
<span class="sd">    block of the specified TextIns command will be replaced with the new one from</span>
<span class="sd">    script_file.</span>

<span class="sd">    script_file should be an LNS script which was initially generated by lmlsb extract.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak unless the</span>
<span class="sd">    --no-backup option is specified.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: modify the function so that it doesn&#39;t write new file for each script during batch insert</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">LNSCompiler</span><span class="p">()</span>
        <span class="n">new_body</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not compile script file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not open LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scenario</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">text_scenarios</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">line_number</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scenario </span><span class="si">{}</span><span class="s2"> at line </span><span class="si">{}</span><span class="s2"> will be replaced.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
            <span class="n">scenario</span><span class="o">.</span><span class="n">replace_body</span><span class="p">(</span><span class="n">new_body</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No matching TextIns command in the specified LSB.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_backup</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backing up original LSB.&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_lsb_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lsb_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote new LSB.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not generate new LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span></div>


<span class="n">CSV_HEADER</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Label&quot;</span><span class="p">,</span> <span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;Original text&quot;</span><span class="p">,</span> <span class="s2">&quot;Translated text&quot;</span><span class="p">]</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;csv_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8-sig&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--lpm&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Include LPM (image) based menus in the extracted output.&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Overwrite existing csv file.&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--append&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Append menu data to existing csv file.&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extractmenu</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">lpm</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract menu choices from the given LSB file to a CSV file.</span>

<span class="sd">    You can open this CSV file for translation in most spreadsheet programs (Excel, Open/Libre Office Calc, etc).</span>
<span class="sd">    Just remember to choose comma as delimiter and &quot; as quotechar.</span>

<span class="sd">    NOTE: If you are using Excel and UTF-8 text, you must also specify --encoding=utf-8-sig, since Excel requires</span>
<span class="sd">    UTF-8 with BOM to handle UTF-8 properly.</span>

<span class="sd">    You can use the --append option to add the text data from this lsb file to a existing csv.</span>
<span class="sd">    With the --overwrite option an existing csv will be overwritten without warning.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="n">PylmProject</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">call_name</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">call_name</span><span class="o">=</span><span class="n">call_name</span><span class="p">,</span> <span class="n">pylm</span><span class="o">=</span><span class="n">pylm</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pylm</span><span class="p">:</span>
        <span class="n">pylm</span><span class="o">.</span><span class="n">update_labels</span><span class="p">(</span><span class="n">lsb</span><span class="p">)</span>

    <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">get_menu_choices</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">LPMSelectionChoice</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lpm</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{choice.name}</span><span class="s2"> (Image: </span><span class="si">{choice.src_file}</span><span class="s2">)&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">text</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">id_</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pylm</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">target_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">resolve_label</span><span class="p">(</span><span class="n">choice</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{target_name}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">target_name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Target: </span><span class="si">{choice.target}{target_name}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">csv_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">text</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No menu data found.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> already exists. Please use --overwrite or --append option.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">append</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> does not exist, but --append specified. A new file will be created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>
        <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="n">append</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">CSV_HEADER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Menu entries extracted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)))</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;csv_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8-sig&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-backup&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not generate backup of original lsb file.&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insertmenu</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply translated menu choices from the given CSV file to given LSB file.</span>

<span class="sd">    CSV_FILE should be a file previously created by the extractmenu command, with added translations.</span>
<span class="sd">    --encoding option must match the values were used for extractmenu.</span>

<span class="sd">    LPM image menus cannot be edited, to translate LPM menus, replace the relevant GAL image files.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak unless the --no-backup option is specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lsb_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Patching </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="n">PylmProject</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">call_name</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pylm</span><span class="o">=</span><span class="n">pylm</span><span class="p">,</span> <span class="n">call_name</span><span class="o">=</span><span class="n">call_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="n">csv_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">untranslated</span> <span class="o">=</span> <span class="n">_patch_csv_menus</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_data</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Translated </span><span class="si">{translated}</span><span class="s2"> choices&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to translate </span><span class="si">{failed}</span><span class="s2"> choices&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ignored </span><span class="si">{untranslated}</span><span class="s2"> untranslated choices&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">translated</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_backup</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backing up original LSB.&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_lsb_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lsb_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote new LSB.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not generate new LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_patch_csv_menus</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch text menus in lsb using csv_data.&quot;&quot;&quot;</span>
    <span class="n">text_objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">untranslated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="n">id_str</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">orig_text</span><span class="p">,</span> <span class="n">translated_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">id_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadTextIdentifierError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># ignore possible header row</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignoring invalid text ID: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">TextMenuIdentifier</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">id_</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">lsb_file</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">translated_text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{id_}</span><span class="s2">: &#39;</span><span class="si">{orig_text}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{translated_text}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">text_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">id_</span><span class="p">,</span> <span class="n">translated_text</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{id_}</span><span class="s2"> Ignoring untranslated text &#39;</span><span class="si">{orig_text}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">untranslated</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">replace_text</span><span class="p">(</span><span class="n">text_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">untranslated</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;csv_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8-sig&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--overwrite&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Overwrite existing csv file.&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--append&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Append text data to existing csv file.&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extractcsv</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">append</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract text from the given LSB file to a CSV file.</span>

<span class="sd">    You can open this CSV file for translation in most spreadsheet programs (Excel, Open/Libre Office Calc, etc).</span>
<span class="sd">    Just remember to choose comma as delimiter and &quot; as quotechar.</span>

<span class="sd">    NOTE: If you are using Excel and UTF-8 text, you must also specify --encoding=utf-8-sig, since Excel requires</span>
<span class="sd">    UTF-8 with BOM to handle UTF-8 properly.</span>

<span class="sd">    You can use the --append option to add the text data from this lsb file to a existing csv.</span>
<span class="sd">    With the --overwrite option an existing csv will be overwritten without warning.</span>

<span class="sd">    NOTE: Formatting tags will be lost when using this command in conjunction with insertcsv.</span>
<span class="sd">    For translating games which use formatting tags, you may need to work directly with LNS scripts</span>
<span class="sd">    using the extract and insert/batchinsert commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lsb_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracting </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="n">PylmProject</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">call_name</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">call_name</span><span class="o">=</span><span class="n">call_name</span><span class="p">,</span> <span class="n">pylm</span><span class="o">=</span><span class="n">pylm</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">id_</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">lsb</span><span class="o">.</span><span class="n">get_text_blocks</span><span class="p">():</span>
        <span class="n">csv_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span> <span class="n">id_</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">name_label</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No text data found.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> already exists. Please use --overwrite or --append option.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">append</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">{}</span><span class="s2"> does not exist, but --append specified. A new file will be created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csv_file</span><span class="p">))</span>
        <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="n">append</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">csv_writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_MINIMAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">append</span><span class="p">:</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">CSV_HEADER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_data</span><span class="p">:</span>
            <span class="n">csv_writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted {len(csv_data)} text blocks.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_patch_csv_text</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch text lines in the given lsb file using csv_data.&quot;&quot;&quot;</span>
    <span class="n">text_objects</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">untranslated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="p">(</span><span class="n">id_str</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">orig_text</span><span class="p">,</span> <span class="n">translated_text</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv_data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">id_</span> <span class="o">=</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">id_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">BadTextIdentifierError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># ignore possible header row</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ignoring invalid text ID: </span><span class="si">{e}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">TextBlockIdentifier</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">id_</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="n">lsb_file</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">translated_text</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{id_}</span><span class="s2">: &#39;</span><span class="si">{orig_text}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{translated_text}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">text_objects</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">id_</span><span class="p">,</span> <span class="n">translated_text</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{id_}</span><span class="s2"> Ignoring untranslated text &#39;</span><span class="si">{orig_text}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">untranslated</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">replace_text</span><span class="p">(</span><span class="n">text_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">untranslated</span>


<span class="nd">@lmlsb</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;lsb_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;csv_file&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dir_okay</span><span class="o">=</span><span class="s2">&quot;False&quot;</span><span class="p">))</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span>
    <span class="s2">&quot;-e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;--encoding&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Choice</span><span class="p">([</span><span class="s2">&quot;cp932&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8-sig&quot;</span><span class="p">]),</span>
    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output text encoding (defaults to utf-8).&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--no-backup&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not generate backup of original lsb file.&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insertcsv</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_file</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">no_backup</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply translated text lines from the given CSV file to given LSB file.</span>

<span class="sd">    CSV_FILE should be a file previously created by the extractcsv command, with added translations.</span>
<span class="sd">    --encoding option must match the values were used for extractcsv.</span>

<span class="sd">    The original LSB file will be backed up to &lt;lsb_file&gt;.bak unless the --no-backup option is specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lsb_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Patching </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="n">PylmProject</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="n">pylm</span><span class="o">.</span><span class="n">call_name</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span><span class="p">:</span>
        <span class="n">pylm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">call_name</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lsb</span> <span class="o">=</span> <span class="n">LMScript</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">call_name</span><span class="o">=</span><span class="n">call_name</span><span class="p">,</span> <span class="n">pylm</span><span class="o">=</span><span class="n">pylm</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadLsbError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Failed to parse file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="n">csv_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="n">translated</span><span class="p">,</span> <span class="n">failed</span><span class="p">,</span> <span class="n">untranslated</span> <span class="o">=</span> <span class="n">_patch_csv_text</span><span class="p">(</span><span class="n">lsb</span><span class="p">,</span> <span class="n">lsb_file</span><span class="p">,</span> <span class="n">csv_data</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Translated </span><span class="si">{translated}</span><span class="s2"> lines&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed to translate </span><span class="si">{failed}</span><span class="s2"> lines&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Ignored </span><span class="si">{untranslated}</span><span class="s2"> untranslated lines&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">translated</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_backup</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Backing up original LSB.&quot;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.bak&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">)))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_lsb_data</span> <span class="o">=</span> <span class="n">lsb</span><span class="o">.</span><span class="n">to_lsb</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lsb_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_lsb_data</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote new LSB.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LiveMakerException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Could not generate new LSB file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pylivemaker</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">pylivemaker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">Command-line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livenovel.html">LiveNovel Docs (en)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pylivemaker.readthedocs.io/en/latest/_static/LiveNovel/index.html">Original LM3 LiveNovel Docs (jp)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../cli.html">livemaker.cli</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Peter Rowlands.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>